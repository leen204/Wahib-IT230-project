<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Donor Home | Wahib</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="base.css">
  <style>
    /* ===== أفقي مع سكرول ناعم ===== */
    .row-scroll{
      display:flex;
      gap:12px;
      overflow-x:auto;
      padding-bottom:6px;
      scroll-snap-type:x mandatory;
      -webkit-overflow-scrolling:touch;
    }
    .row-scroll::-webkit-scrollbar{height:8px}
    .row-scroll::-webkit-scrollbar-thumb{background:#e5e7eb;border-radius:999px}
    .request-card{
      flex:0 0 320px;              /* عرض ثابت لكل كرت */
      scroll-snap-align:start;     /* يسنتر عند الوقوف */
      padding:14px;
      border-radius:12px;
      background:#fff;
      border:1px solid #f0f0f0;
      box-shadow:0 8px 30px rgba(0,0,0,.04);
    }
    @media(max-width:420px){ .request-card{flex-basis:280px} }
  </style>
</head>
<body onload="guard('donor')">
<header class="w-header"></header>

<section class="container">
  <div style="display:flex;gap:10px;align-items:center;justify-content:center;margin-bottom:12px">
    <input id="q" placeholder="Search by hospital name or blood type (e.g., A-)" style="max-width:560px">
    <button class="w-btn" onclick="doSearch()">Search</button>
  </div>

  <h2>My Upcoming Appointment</h2>
  <div id="apptBox" class="panel"></div>

  <h2>Available Blood Requests</h2>

  <!-- suitable -->
  <div class="panel" style="margin-top:12px">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0" id="suitableTitle">Requests Suitable for Your Blood Type</h3>
      <div class="muted" id="suitableCount"></div>
    </div>
    <div id="suitableRow" class="row-scroll"></div>
  </div>

  <!-- others -->
  <div class="panel" style="margin-top:12px">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0">Other Public Requests</h3>
      <div class="muted" id="otherCount"></div>
    </div>
    <div id="otherRow" class="row-scroll"></div>
  </div>
</section>

<div id="w-toast"></div>
<div id="w-confirm">
  <div class="box">
    <h3 id="w-confirm-title">Confirm</h3>
    <p id="w-confirm-msg">Are you sure?</p>
    <div class="actions">
      <button class="w-btn secondary" id="w-cancel">Cancel</button>
      <button class="w-btn" id="w-ok">Yes</button>
    </div>
  </div>
</div>

<script src="app.js"></script>
<script src="ui.js"></script>
<script src="footer.js"></script>

<script>
/* ===== Helpers ===== */
function badge(status){
  const s = (status||'').toLowerCase();
  if(s==='emergency') return '<span class="tag emg">Emergency</span>';
  return '<span class="tag open">Open</span>';
}
const _get = (k,def) => JSON.parse(localStorage.getItem(k)||def);
const _acc  = () => (typeof getAcc==='function'?getAcc():_get('wahib_account','{}'));
const _reqs = () => (typeof getReqs==='function'?getReqs():_get('wahib_requests','[]'));
const _apts = () => (typeof getAppts==='function'?getAppts():_get('wahib_appointments','[]'));
const _eligible = () => (typeof getEligible==='function'?getEligible():_get('wahib_eligible','false'));
const _setSel = (r)=> (typeof setSelectedReq==='function'?setSelectedReq(r):localStorage.setItem('wahib_selected_req',JSON.stringify(r)));
const _hasActive = () => (typeof hasActiveAppt==='function'?hasActiveAppt():_apts().length>0);

/* ===== Appointment ===== */
function renderAppt(){
  const a=_apts()[0]; const el=document.getElementById('apptBox');
  if(!a){ el.innerHTML='<div class="muted">No appointment yet.</div>'; return; }
  el.innerHTML=`
    <div style="display:flex;justify-content:space-between;align-items:center;gap:16px;flex-wrap:wrap">
      <div>
        <div style="font-weight:800">${a.hospital}</div>
        <div class="muted">${a.date} • ${a.time} • Blood: <b>${a.blood}</b></div>
        <div><span class="tag open">Confirmed</span></div>
      </div>
      <div style="display:flex;gap:8px">
        <a class="w-btn ghost" href="edit_appointment.html">Edit</a>
        <button class="w-btn secondary" onclick="delAppt(${a.id})">Delete</button>
      </div>
    </div>`;
}
async function delAppt(id){
  const ok=await confirmBox('Are you sure you want to delete this appointment?');
  if(!ok) return;
  const left=_apts().filter(x=>x.id!==id);
  localStorage.setItem('wahib_appointments',JSON.stringify(left));
  renderAppt(); toast('Appointment deleted.');
}

/* ===== Defaults (عشان التجربة) ===== */
const defaults=[
  {id:1,hospital:'King Fahad Medical City',city:'Riyadh',location:'Olaya',blood:'O+',quantity:5,status:'Open'},
  {id:2,hospital:'King Khalid Hospital',city:'Riyadh',location:'North Wing',blood:'A-',quantity:3,status:'Emergency'},
  {id:3,hospital:'Al Habib Hospital',city:'Jeddah',location:'Tahlia',blood:'B+',quantity:4,status:'Open'},
  {id:4,hospital:'King Saud University Hospital',city:'Riyadh',location:'Malaz',blood:'AB+',quantity:2,status:'Open'},
  {id:5,hospital:'Riyadh Central Hospital',city:'Riyadh',location:'Campus',blood:'O+',quantity:8,status:'Open'}
];

/* ===== Card ===== */
function card(r){
  return `
    <div class="request-card">
      <div style="font-weight:800">${r.hospital}</div>
      <div class="muted" style="margin-top:6px">${r.city} • ${r.location}</div>
      <div style="margin:10px 0;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <span class="tag">Blood: ${r.blood}</span>
        <span class="tag">Qty: ${r.quantity}</span>
        ${badge(r.status)}
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="w-btn ghost" onclick="openDetails(${r.id})">Details</button>
        <button class="w-btn" onclick="book(${r.id})">Book</button>
      </div>
    </div>`;
}

/* ===== Render rows (أفقي بسكرول) ===== */
function renderRows(data){
  const me=_acc(); const blood=(me.blood||'O+');
  let all=_reqs(); if(!all||!all.length) all=defaults;

  const can = (typeof canDonate==='function') ? (b1,b2)=>canDonate(b1,b2) : (b1,b2)=>b1===b2;
  const suitable = (data||all).filter(r=>can(blood,r.blood));
  const others   = (data||all).filter(r=>!suitable.includes(r));

  document.getElementById('suitableTitle').textContent=`Requests Suitable for Your Blood Type (${blood})`;
  document.getElementById('suitableCount').textContent = `${suitable.length} match${suitable.length!==1?'es':''}`;
  document.getElementById('otherCount').textContent    = `${others.length} public`;

  const sRow=document.getElementById('suitableRow');
  const oRow=document.getElementById('otherRow');
  sRow.innerHTML = suitable.length ? suitable.map(card).join('') : '<div class="muted" style="padding:8px 2px">No perfect matches right now.</div>';
  oRow.innerHTML = others.length   ? others.map(card).join('')   : '<div class="muted" style="padding:8px 2px">No other public requests.</div>';
}

/* ===== Search يبقى نفس المبدأ ===== */
function doSearch(){
  const text=(q.value||'').trim().toLowerCase();
  let all=_reqs(); if(!all||!all.length) all=defaults;
  if(!text){ renderRows(all); return; }
  const out=all.filter(r=>
    (r.hospital||'').toLowerCase().includes(text) ||
    (r.blood||'').toLowerCase()===text
  );
  renderRows(out.length?out:all);
}

/* ===== Details & Booking ===== */
function openDetails(id){
  let all=_reqs(); if(!all||!all.length) all=defaults;
  const req=all.find(r=>r.id===id)||defaults.find(r=>r.id===id);
  if(!req){ toast('Request not found','err'); return; }
  _setSel(req); location.href='request_details.html';
}
function book(id){
  if(_hasActive()){ toast('You already have an active appointment. Edit or delete it first.','err'); return; }
  let all=_reqs(); if(!all||!all.length) all=defaults;
  const req=all.find(r=>r.id===id)||defaults.find(r=>r.id===id);
  if(!req){ toast('Request not found','err'); return; }
  if(!_eligible()){ toast('Complete the Eligibility Test from your profile first.','err'); return; }
  _setSel(req); location.href='book_appointment.html';
}

/* ===== Boot ===== */
setTimeout(()=>{ if(!_eligible()) toast('Reminder: please complete the Eligibility Test from your profile.'); },1200);
renderAppt();
renderRows();
</script>

</body>
</html>
