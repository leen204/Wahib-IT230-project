<!DOCTYPE html><html lang="en" dir="ltr"><head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Donor Home | Wahib</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="base.css">
</head><body onload="guard('donor')">
<header class="w-header"></header>

<section class="container">
  <div style="display:flex;gap:10px;align-items:center;justify-content:center;margin-bottom:12px">
    <input id="q" placeholder="Search by hospital name or blood type (e.g., A-)" style="max-width:560px">
    <button class="w-btn" onclick="doSearch()">Search</button>
  </div>

  <h2>My Upcoming Appointment</h2>
  <div id="apptBox" class="panel"></div>

  <h2>Available Blood Requests</h2>
  <div id="cards" style="display:grid;gap:14px;grid-template-columns:repeat(3,minmax(0,1fr))"></div>
</section>


<div id="w-toast"></div>
<div id="w-confirm"><div class="box">
  <h3 id="w-confirm-title">Confirm</h3><p id="w-confirm-msg">Are you sure?</p>
  <div class="actions"><button class="w-btn secondary" id="w-cancel">Cancel</button><button class="w-btn" id="w-ok">Yes</button></div>
</div></div>
<script src="app.js"></script>
<script src="ui.js"></script>
<script src="footer.js"></script>
<script>
/* شارة حالة الطلب */
function badge(status){
  const s = (status||'').toLowerCase();
  if(s==='emergency') return '<span class="tag emg">Emergency</span>';
  return '<span class="tag open">Open</span>';
}

function renderAppt(){
  const a = getAppts()[0]; // موعد واحد نشط كنسخة واجهة
  const el = document.getElementById('apptBox');
  if(!a){
    el.innerHTML = '<div class="muted">No appointment yet.</div>';
    return;
  }
  el.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;gap:16px;flex-wrap:wrap">
      <div>
        <div style="font-weight:800">${a.hospital}</div>
        <div class="muted">${a.date} • ${a.time} • Blood: <b>${a.blood}</b></div>
        <div><span class="tag open">Confirmed</span></div>
      </div>
      <div style="display:flex;gap:8px">
        <a class="w-btn ghost" href="edit_appointment.html">Edit</a>
        <button class="w-btn secondary" onclick="delAppt(${a.id})">Delete</button>
      </div>
    </div>`;
}

async function delAppt(id){
  const ok = await confirmBox('Are you sure you want to delete this appointment?');
  if(!ok) return;
  removeAppointment(id);
  renderAppt();
  toast('Appointment deleted.');
}

/* رسم قائمة الطلبات (مفلترة حسب توافق فصيلة المتبرع) */
function list(reqs){
  const me = getAcc();
  const wrap = document.getElementById('cards');
  if(!reqs) reqs = getReqs();

  // نعرض فقط الطلبات المتوافقة مع فصيلة المتبرع + نرتّب بحيث المتوافقة أولاً
  const filtered = reqs
    .filter(r => canDonate(me.blood, r.blood))
    .sort((a,b)=> (a.blood===me.blood? -1:1));

  if(filtered.length===0){
    wrap.innerHTML = '<div class="panel"><div class="muted">No compatible requests right now.</div></div>';
    return;
  }

  wrap.innerHTML = filtered.map(r=>`
    <div class="panel">
      <div style="font-weight:800">${r.hospital}</div>
      <div class="muted">${r.city} • ${r.location}</div>
      <div style="margin:8px 0;display:flex;gap:8px;flex-wrap:wrap">
        <span class="tag">Blood: ${r.blood}</span>
        <span class="tag">Qty: ${r.quantity}</span>
        ${badge(r.status)}
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="w-btn ghost" onclick="openDetails(${r.id})">Details</button>
        <button class="w-btn" onclick="book(${r.id})">Book</button>
      </div>
    </div>`).join('');
}

/* بحث بسيط بالاسم أو فصيلة الدم */
function doSearch(){
  const text = (q.value||'').trim().toLowerCase();
  const all = getReqs().filter(r => canDonate(getAcc().blood, r.blood)); // نحافظ على التوافق
  if(!text) return list(all);
  const out = all.filter(r =>
    r.hospital.toLowerCase().includes(text) ||
    r.blood.toLowerCase()===text
  );
  list(out);
}

/* فتح صفحة التفاصيل */
function openDetails(id){
  const req = getReqs().find(r=>r.id===id);
  if(!req){ toast('Request not found','err'); return; }
  setSelectedReq(req);           // من app.js
  location.href = 'request_details.html';
}

/* حجز — موعد واحد فقط */
function book(id){
  if(hasActiveAppt()){
    toast('You already have an active appointment. Edit or delete it first.','err');
    return;
  }
  const req = getReqs().find(r=>r.id===id);
  if(!req){ toast('Request not found','err'); return; }
  // تأكد من اجتياز اختبار الأهلية
  if(!getEligible()){
    toast('Complete the Eligibility Test from your profile first.','err');
    return;
  }
  setSelectedReq(req);           // نخزّن الطلب المحدد
  location.href = 'book_appointment.html';
}

/* تلميح أهلية بسيط (popup غير مزعج) */
setTimeout(()=>{
  if(!getEligible()){
    toast('Reminder: please complete the Eligibility Test from your profile.');
  }
}, 1200);

renderAppt();
list();
</script>

</body></html>
