<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hospital Dashboard | Wahib</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="base.css">
</head>
<body onload="guard('hospital')">

<header class="w-header"></header>

<!-- ====== المحتوى المرئي فقط ====== -->
<section class="container">
  <h2 id="title">Hospital Dashboard</h2>

  <!-- KPIs -->
  <div style="display:grid;gap:14px;grid-template-columns:repeat(3,minmax(0,1fr))">
    <div class="panel">
      <div style="font-size:12px;color:#777">Total Requests</div>
      <div id="k1" style="font-weight:800;font-size:28px">0</div>
    </div>
    <div class="panel">
      <div style="font-size:12px;color:#777">Open / Emergency</div>
      <div>
        <span id="k2" style="font-weight:800;font-size:26px">0</span>
        <span class="tag emg" id="k3">0 EMG</span>
      </div>
    </div>
    <div class="panel">
      <div style="font-size:12px;color:#777">Upcoming Bookings</div>
      <div id="k4" style="font-weight:800;font-size:28px">0</div>
    </div>
  </div>

  <!-- Stock + Recent (مثل الصفحة المليانة) -->
  <div style="display:grid;gap:14px;grid-template-columns:1fr 1fr;margin-top:14px">
    <!-- Blood Stock -->
    <div class="panel">
      <h3 style="margin:0 0 8px">Blood Stock — Units on Hand</h3>

      <!-- الحاوية التي سترسم فيها الأشرطة -->
      <div id="stockBody" style="display:grid;gap:8px"></div>

      <!-- legend -->
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
        <span class="tag">Good ≥ 8</span>
        <span class="tag" style="background:#fff7ed;border:1px solid #fed7aa;color:#b45309">Low 4–7</span>
        <span class="tag emg" style="background:#fee2e2;border:1px solid #fecaca;color:#b91c1c">Critical &lt; 4</span>
      </div>
    </div>

    <!-- Recent Requests -->
    <div class="panel">
      <h3 style="margin:0 0 8px">Recent Requests</h3>
      <table class="table">
        <thead>
          <tr><th>Blood</th><th>Qty</th><th>Status</th><th>Location</th><th>ID</th></tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
      <a class="w-btn" href="add_request.html" style="margin-top:10px">+ Add Request</a>
    </div>
  </div>

  <!-- Upcoming Bookings -->
  <div class="panel" style="margin-top:14px">
    <h3 style="margin:0 0 8px">Upcoming Bookings</h3>
    <table class="table">
      <thead><tr><th>Donor</th><th>Date</th><th>For</th><th>Status</th></tr></thead>
      <tbody id="books"></tbody>
    </table>
  </div>
</section>
<!-- ====== /المحتوى المرئي ====== -->

<footer class="w-footer"></footer>
<div id="w-toast"></div>
<div id="w-confirm">
  <div class="box">
    <h3 id="w-confirm-title">Confirm</h3>
    <p id="w-confirm-msg">Are you sure?</p>
    <div class="actions">
      <button class="w-btn secondary" id="w-cancel">Cancel</button>
      <button class="w-btn" id="w-ok">Yes</button>
    </div>
  </div>
</div>

<script src="app.js"></script>
<script src="ui.js"></script>
<script src="footer.js"></script>

<script>
  // ثبّتي المراجع بدل الاعتماد على IDs كمتغيّرات
  const titleEl = document.getElementById('title');
  const rowsEl  = document.getElementById('rows');
  const booksEl = document.getElementById('books');
  const stockEl = document.getElementById('stockBody');

  const H = (getAcc().hospitalName || 'Hospital');
  titleEl.textContent = `${H} — Dashboard`;

  const reqs = getReqs().filter(r => r.hospital === H);
  document.getElementById('k1').textContent = reqs.length;
  document.getElementById('k2').textContent = reqs.filter(r => r.status === 'Open').length;
  document.getElementById('k3').textContent = reqs.filter(r => r.status === 'Emergency').length + ' EMG';
  document.getElementById('k4').textContent = 0; // لا يوجد باك-إند للحجوزات الآن

  // Recent Requests
  rowsEl.innerHTML = (reqs.slice(-5).reverse()).map(r => `
    <tr>
      <td><b>${r.blood ?? '-'}</b></td>
      <td>${r.quantity ?? '-'}</td>
      <td>${typeof tag === 'function' ? tag(r.status ?? 'Open') : (r.status ?? 'Open')}</td>
      <td>${(r.city ?? '-') + ' • ' + (r.location ?? '-')}</td>
      <td>#${r.id}</td>
    </tr>
  `).join('') || `<tr><td colspan="5" class="muted">No requests.</td></tr>`;

  // Upcoming Bookings (لسه مافيه باك-إند)
  booksEl.innerHTML = `<tr><td colspan="4" class="muted">No bookings yet.</td></tr>`;

  // رسم مخزون الدم
  (function renderStock(){
    if (!stockEl) return;
    const key = 'wahib_stock';
    const stock = (typeof getStock === 'function')
      ? (getStock() || {})
      : JSON.parse(localStorage.getItem(key) || '{}');

    const order = ['O-','O+','A-','A+','B-','B+','AB-','AB+'];
    const maxUnits = Math.max(8, ...order.map(t => stock[t] || 0));

    stockEl.innerHTML = order.map(type => {
      const v = stock[type] ?? 0;
      const ratio = Math.min(100, Math.round((v / maxUnits) * 100));
      const level = (v < 4) ? '#ef4444' : (v < 8) ? '#f59e0b' : '#b91c1c';
      return `
        <div style="display:flex;align-items:center;gap:10px">
          <strong style="width:48px">${type}</strong>
          <div style="flex:1;height:10px;background:#f1f1f1;border-radius:999px;overflow:hidden">
            <span style="display:block;height:100%;width:${ratio}%;background:${level}"></span>
          </div>
          <span style="width:44px;text-align:right;font-weight:800">${v}</span>
        </div>
      `;
    }).join('');
  })();
</script>


</body>
</html>
